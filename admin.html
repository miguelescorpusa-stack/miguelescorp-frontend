<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administrativo ‚Äî MiguelesCorp</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; line-height: 1.4; }
    h1, h2 { margin: 0 0 8px; }
    .muted { color: #666; font-size: 0.95rem; }
    .card { border: 2px solid #222; border-radius: 12px; padding: 16px; margin: 18px 0; max-width: 760px; }
    label { display:block; margin: 10px 0 4px; font-weight: 600; }
    input, select, button, textarea {
      width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #222; font-size: 16px;
      background: #fff; color:#000;
    }
    button { width: auto; background:#000; color:#fff; cursor:pointer; margin-top: 12px; }
    button.secondary { background:#fff; color:#000; border:2px solid #000; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .ok { color: #0a7a0a; font-weight:700; }
    .err { color: #b00020; font-weight:700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 0.95rem; }
    details { margin-top: 10px; }
    a { color:#3b5ed7; }
  </style>
</head>
<body>
  <a href="/index.html">‚Üê Volver al mapa</a>
  <h1>üõ†Ô∏è Panel Administrativo</h1>
  <p class="muted">Carga, actualiza y geolocaliza env√≠os. El token admin se guarda localmente en tu navegador (no en el c√≥digo).</p>

  <!-- Configurar token -->
  <div class="card" aria-labelledby="cfgTitle">
    <h2 id="cfgTitle">Configurar Token Admin</h2>
    <p class="muted">Necesario para los endpoints <span class="mono">/admin/*</span>.</p>
    <div class="row">
      <div>
        <label for="token">Token</label>
        <input id="token" type="password" placeholder="mc_admin_..." />
      </div>
      <div style="align-self:end">
        <button id="saveTokenBtn">Guardar token</button>
        <button class="secondary" id="clearTokenBtn">Borrar token</button>
      </div>
    </div>
    <p id="tokenStatus" class="muted"></p>
  </div>

  <!-- Crear/actualizar env√≠o -->
  <div class="card" aria-labelledby="envioTitle">
    <h2 id="envioTitle">Crear / Actualizar env√≠o</h2>
    <p class="muted">Usa el endpoint p√∫blico <span class="mono">POST /shipments</span> (no requiere token). Crea el env√≠o con direcci√≥n destino.</p>

    <label for="ref_code">Nombre del cliente (ref_code)</label>
    <input id="ref_code" placeholder="Ej. CLIENTE-DE-PRUEBA" />

    <label for="status">Estado</label>
    <select id="status">
      <option value="pending">pending</option>
      <option value="in_transit" selected>in_transit</option>
      <option value="delivered">delivered</option>
    </select>

    <label for="dest_addr">Direcci√≥n destino</label>
    <input id="dest_addr" placeholder="Ej. 1015 N America Way, Miami, FL 33132" />

    <button id="saveShipmentBtn">Guardar env√≠o</button>
    <p id="shipmentMsg"></p>

    <details>
      <summary>Respuesta cruda</summary>
      <pre id="shipmentRaw" class="mono"></pre>
    </details>
  </div>

  <!-- Agregar ubicaci√≥n por direcci√≥n -->
  <div class="card" aria-labelledby="addrTitle">
    <h2 id="addrTitle">Agregar ubicaci√≥n ‚Äî por direcci√≥n</h2>
    <p class="muted">Endpoint protegido <span class="mono">POST /admin/locations/add-by-address</span> (usa tu token).</p>

    <label for="ref_code_addr">C√≥digo de env√≠o (ref_code)</label>
    <input id="ref_code_addr" placeholder="Ej. CLIENTE-DE-PRUEBA" />

    <label for="addr_text">Direcci√≥n</label>
    <input id="addr_text" placeholder="Ej. Brickell City Centre, Miami, FL" />

    <button id="addByAddressBtn">Agregar punto</button>
    <p id="addrMsg"></p>

    <details>
      <summary>Respuesta cruda</summary>
      <pre id="addrRaw" class="mono"></pre>
    </details>
  </div>

  <!-- Agregar ubicaci√≥n por coordenadas -->
  <div class="card" aria-labelledby="coordTitle">
    <h2 id="coordTitle">Agregar ubicaci√≥n ‚Äî por coordenadas</h2>
    <p class="muted">Endpoint protegido <span class="mono">POST /admin/locations/add</span> (usa tu token).</p>

    <label for="ref_code_xy">C√≥digo de env√≠o (ref_code)</label>
    <input id="ref_code_xy" placeholder="Ej. CLIENTE-DE-PRUEBA" />

    <div class="row">
      <div>
        <label for="lat">Latitud</label>
        <input id="lat" type="number" step="0.000001" placeholder="25.7674" />
      </div>
      <div>
        <label for="lon">Longitud</label>
        <input id="lon" type="number" step="0.000001" placeholder="-80.1936" />
      </div>
    </div>

    <button id="addByCoordsBtn">Agregar punto</button>
    <p id="coordsMsg"></p>

    <details>
      <summary>Respuesta cruda</summary>
      <pre id="coordsRaw" class="mono"></pre>
    </details>
  </div>

  <!-- Acceso r√°pido al mapa -->
  <div class="card">
    <h2>Ver en mapa</h2>
    <div class="row">
      <div>
        <label for="ref_view">C√≥digo de env√≠o (ref_code)</label>
        <input id="ref_view" placeholder="Ej. CLIENTE-DE-PRUEBA" />
      </div>
      <div style="align-self:end">
        <button id="viewOnMapBtn">Ver env√≠o en mapa</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://www.miguelescorp.com';

    // ===== Token admin (localStorage) =====
    const tokenInput = document.getElementById('token');
    const tokenStatus = document.getElementById('tokenStatus');
    const saveTokenBtn = document.getElementById('saveTokenBtn');
    const clearTokenBtn = document.getElementById('clearTokenBtn');

    function getToken() { return localStorage.getItem('mc_admin_token') || ''; }
    function setToken(t) { localStorage.setItem('mc_admin_token', t || ''); }
    function updateTokenUI() {
      const t = getToken();
      tokenInput.value = t;
      tokenStatus.textContent = t ? 'Token guardado en este navegador.' : 'Sin token.';
    }
    saveTokenBtn.onclick = () => { setToken(tokenInput.value.trim()); updateTokenUI(); };
    clearTokenBtn.onclick = () => { setToken(''); updateTokenUI(); };
    updateTokenUI();

    // ===== Helpers =====
    async function postJSON(path, body, needsAuth=false) {
      const headers = { 'Content-Type': 'application/json' };
      if (needsAuth) {
        const t = getToken();
        if (!t) throw new Error('Falta token admin. Config√∫ralo arriba.');
        headers['Authorization'] = 'Bearer ' + t;
      }
      const r = await fetch(API_BASE + path, {
        method: 'POST',
        headers,
        body: JSON.stringify(body)
      });
      const txt = await r.text();
      let data = null;
      try { data = JSON.parse(txt); } catch { /* html error */ }
      if (!r.ok) {
        const msg = data?.error || ('http_error_' + r.status);
        throw new Error(msg + ' ‚Äî ' + txt);
      }
      return { data, raw: txt };
    }

    // ===== Crear/actualizar env√≠o (p√∫blico) =====
    const refInput = document.getElementById('ref_code');
    const statusSel = document.getElementById('status');
    const destInput = document.getElementById('dest_addr');
    const saveShipmentBtn = document.getElementById('saveShipmentBtn');
    const shipmentMsg = document.getElementById('shipmentMsg');
    const shipmentRaw = document.getElementById('shipmentRaw');

    saveShipmentBtn.onclick = async () => {
      shipmentMsg.textContent = '';
      shipmentRaw.textContent = '';
      try {
        const body = {
          ref_code: (refInput.value || '').trim(),
          status: (statusSel.value || '').trim(),
          destination_address: (destInput.value || '').trim()
        };
        if (!body.ref_code || !body.status || !body.destination_address) {
          throw new Error('missing_fields');
        }
        const { data, raw } = await postJSON('/shipments', body, false);
        shipmentMsg.innerHTML = `<span class="ok">‚úî Env√≠o guardado</span>`;
        shipmentRaw.textContent = raw;
      } catch (err) {
        shipmentMsg.innerHTML = `<span class="err">‚úñ Error: ${err.message}</span>`;
      }
    };

    // ===== Agregar por direcci√≥n (admin) =====
    const refAddr = document.getElementById('ref_code_addr');
    const addrText = document.getElementById('addr_text');
    const addByAddressBtn = document.getElementById('addByAddressBtn');
    const addrMsg = document.getElementById('addrMsg');
    const addrRaw = document.getElementById('addrRaw');

    addByAddressBtn.onclick = async () => {
      addrMsg.textContent = '';
      addrRaw.textContent = '';
      try {
        const body = {
          shipment_ref: (refAddr.value || '').trim(),
          address: (addrText.value || '').trim()
        };
        if (!body.shipment_ref || !body.address) {
          throw new Error('missing_fields');
        }
        const { data, raw } = await postJSON('/admin/locations/add-by-address', body, true);
        addrMsg.innerHTML = `<span class="ok">‚úî Punto agregado</span> (lat: ${data.lat}, lon: ${data.lon})`;
        addrRaw.textContent = raw;
      } catch (err) {
        addrMsg.innerHTML = `<span class="err">‚úñ Error: ${err.message}</span>`;
      }
    };

    // ===== Agregar por coordenadas (admin) =====
    const refXY = document.getElementById('ref_code_xy');
    const latInput = document.getElementById('lat');
    const lonInput = document.getElementById('lon');
    const addByCoordsBtn = document.getElementById('addByCoordsBtn');
    const coordsMsg = document.getElementById('coordsMsg');
    const coordsRaw = document.getElementById('coordsRaw');

    addByCoordsBtn.onclick = async () => {
      coordsMsg.textContent = '';
      coordsRaw.textContent = '';
      try {
        const body = {
          shipment_ref: (refXY.value || '').trim(),
          lat: Number(latInput.value),
          lon: Number(lonInput.value)
        };
        if (!body.shipment_ref || Number.isNaN(body.lat) || Number.isNaN(body.lon)) {
          throw new Error('missing_fields');
        }
        const { raw } = await postJSON('/admin/locations/add', body, true);
        coordsMsg.innerHTML = `<span class="ok">‚úî Punto agregado</span>`;
        coordsRaw.textContent = raw;
      } catch (err) {
        coordsMsg.innerHTML = `<span class="err">‚úñ Error: ${err.message}</span>`;
      }
    };

    // ===== Ver en mapa =====
    document.getElementById('viewOnMapBtn').onclick = () => {
      const r = (document.getElementById('ref_view').value || '').trim();
      if (!r) { alert('Ingresa ref_code'); return; }
      // Tu index.html busca por ref_code. Abrimos y rellenamos el campo v√≠a querystring.
      window.location.href = `/index.html?ref=${encodeURIComponent(r)}`;
    };
  <script>
function saveToken() {
  const token = document.getElementById('tokenInput').value.trim();
  if (token) {
    localStorage.setItem('adminToken', token);
    alert('‚úÖ Token guardado correctamente');
    document.getElementById('tokenStatus').innerText = 'Token activo';
  } else {
    alert('Ingresa un token v√°lido');
  }
}

function clearToken() {
  localStorage.removeItem('adminToken');
  alert('‚ùå Token eliminado');
  document.getElementById('tokenStatus').innerText = 'Sin token.';
}
</script>
</body>
</html>
