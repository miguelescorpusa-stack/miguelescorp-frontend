<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rastreo con Mapa ‚Äî MiguelesCorp</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:1100px;margin:24px auto;padding:0 16px}
    header{margin-bottom:16px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    label{display:block;margin:8px 0 4px;font-weight:600}
    input{padding:8px;border:1px solid #ccc;border-radius:8px;width:100%}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
    .primary{background:#111;color:#fff}
    #map{height:520px;border-radius:12px;border:1px solid #ddd}
    .muted{color:#666}
    ul{margin:6px 0 0 18px}
    pre{background:#fafafa;border:1px solid #eee;border-radius:8px;padding:12px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <h1>üó∫Ô∏è Rastreo con Mapa ‚Äî MiguelesCorp</h1>
    <p class="muted">Ingresa un c√≥digo (ej. <b>MIAMI-001</b>). Ver√°s las posiciones m√°s recientes.</p>
  </header>

  <div class="grid">
    <section class="card">
      <label for="codigo">C√≥digo de env√≠o</label>
      <input id="codigo" placeholder="Ej: MIAMI-001" value="MIAMI-001" />
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="primary" onclick="buscar()">Buscar</button>
        <button onclick="listar()">Ver todos</button>
        <button onclick="probar()">Probar backend</button>
      </div>

      <div id="panel" style="margin-top:14px" class="muted">
        Escribe un c√≥digo y pulsa <b>Buscar</b> o <b>Ver todos</b>.
      </div>

      <details style="margin-top:12px;">
        <summary>Respuesta cruda</summary>
        <pre id="raw" hidden></pre>
      </details>
    </section>

    <section class="card">
      <div id="map"></div>
    </section>
  </div>

  <script>
    // Tu backend en Vercel
    const API_BASE = "https://miguelescorp.com";

    let map, markersLayer;

    function initMap(){
      // Miami por defecto
      map = L.map('map').setView([25.774, -80.197], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }
    initMap();

    function pintarLoading(){
      document.getElementById('panel').innerHTML = '<p class="muted">Cargando‚Ä¶</p>';
      document.getElementById('raw').hidden = true;
      markersLayer.clearLayers();
    }

    function renderError(err){
      const msg = (err && err.message) ? err.message : String(err);
      document.getElementById('panel').innerHTML = `<p style="color:#b00020">Error: ${msg}</p>`;
      document.getElementById('raw').hidden = true;
      markersLayer.clearLayers();
    }

    async function probar(){
      try{
        const r = await fetch(`${API_BASE}/health`, { mode:'cors', cache:'no-store' });
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        alert('Backend OK: ' + JSON.stringify(data));
      }catch(e){
        alert('Fallo: ' + (e.message || e));
        console.error('probar() error:', e);
      }
    }

    async function listar(){
      pintarLoading();
      try{
        const r = await fetch(`${API_BASE}/shipments`, { mode:'cors', cache:'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        if(!data.ok) throw new Error(data.error || 'Error de API');

        const items = (data.shipments||[]).map(s=>`
          <li><b>${s.ref_code}</b> ‚Äî ${s.tracking_number} ‚Äî <i>${s.status}</i>
            <button onclick="ver('${s.ref_code}')">Ver en mapa</button>
          </li>`).join('');
        document.getElementById('panel').innerHTML = items ? `<ul>${items}</ul>` : 'Sin env√≠os.';
      }catch(e){ renderError(e); }
    }

    async function ver(ref){ document.getElementById('codigo').value = ref; await buscar(); }

    async function buscar(){
      const codigo = document.getElementById('codigo').value.trim();
      if(!codigo){ alert('Escribe un c√≥digo'); return; }
      pintarLoading();

      try{
        const r = await fetch(`${API_BASE}/track/${encodeURIComponent(codigo)}`, { mode:'cors', cache:'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        if(!data.ok) throw new Error(data.error || 'Error de API');

        const s = data.shipment;
        const locs = data.locations || [];

        document.getElementById('panel').innerHTML = `
          <p><b>${s.ref_code}</b> ‚Äî ${s.tracking_number} ‚Äî <i>${s.status}</i></p>
          <p class="muted">Puntos: ${locs.length}</p>
        `;

        // Pintar en mapa
        markersLayer.clearLayers();
        if(locs.length){
          const bounds = [];
          locs.forEach(l=>{
            const m = L.marker([+l.lat, +l.lon]).addTo(markersLayer);
            m.bindPopup(`<b>${s.ref_code}</b><br>${new Date(l.ts).toLocaleString()}<br>(${l.lat}, ${l.lon})`);
            bounds.push([+l.lat, +l.lon]);
          });
          if(bounds.length === 1) map.setView(bounds[0], 14);
          else map.fitBounds(bounds, {padding:[20,20]});
        }

        // Mostrar JSON crudo
        const pre = document.getElementById('raw');
        pre.textContent = JSON.stringify(data, null, 2);
        pre.hidden = false;

      }catch(e){ renderError(e); }
    }
  </script>
</body>
</html>
