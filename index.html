<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rastreo con Mapa ‚Äî MiguelesCorp</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; line-height: 1.4; }
    h1 { margin: 0 0 12px; }
    .muted { color:#666; }
    .wrap { display: grid; grid-template-columns: 320px 1fr; gap: 16px; }
    .panel { border: 2px solid #222; border-radius: 12px; padding: 12px; }
    label { font-weight: 700; display:block; margin: 6px 0 4px; }
    input, button {
      width: 100%; padding: 10px; border:2px solid #222; border-radius: 8px; font-size: 16px;
      background:#fff; color:#000;
    }
    button { width: auto; background:#000; color:#fff; cursor:pointer; margin-top: 8px; }
    #map { height: 520px; border: 2px solid #222; border-radius: 12px; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: .95rem; }
    details { margin-top: 10px; }
    a { color:#3b5ed7; }
    .chip { display:inline-block; padding:2px 8px; border-radius: 999px; border:1px solid #222; font-size:.85rem; }
  </style>
</head>
<body>
  <h1>üó∫Ô∏è Rastreo con Mapa ‚Äî MiguelesCorp</h1>
  <p class="muted">Ingresa un c√≥digo (ej. <strong>MIAMI-001</strong>) o abre con <span class="mono">?ref=</span> o <span class="mono">?seq=</span>.</p>

  <div class="wrap">
    <!-- Lado izquierdo -->
    <div class="panel" aria-labelledby="searchTitle">
      <h2 id="searchTitle" style="margin:0 0 8px;">C√≥digo de env√≠o</h2>

      <label for="shipment_ref">ref_code</label>
      <input id="shipment_ref" placeholder="Ej. CLIENTE-DE-PRUEBA" />
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="searchBtn">Buscar</button>
        <button id="viewAllBtn" class="chip" title="Lista resumida">Ver todos</button>
        <a href="/admin.html" class="chip" style="text-decoration:none;">Ir al panel admin</a>
      </div>

      <div id="resultInfo" style="margin-top:12px;"></div>

      <details>
        <summary>Respuesta cruda</summary>
        <pre id="raw" class="mono"></pre>
      </details>
    </div>

    <!-- Mapa -->
    <div id="map" role="region" aria-label="Mapa de rastreo"></div>
  </div>

  <script>
    const API = 'https://www.miguelescorp.com';
    let map, markersLayer;

    function ensureMap() {
      if (map) return map;
      map = L.map('map').setView([25.774, -80.197], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '¬© OpenStreetMap'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      return map;
    }

    function renderShipmentView(data) {
      const info = document.getElementById('resultInfo');
      const raw = document.getElementById('raw');
      raw.textContent = JSON.stringify(data, null, 2);
      if (!data.ok) {
        info.innerHTML = `<span style="color:#b00020">Error: ${data.error || 'not_found'}</span>`;
        markersLayer.clearLayers();
        return;
      }
      const s = data.shipment;
      info.innerHTML = `
        <div style="margin:6px 0">
          <strong>${s.ref_code}</strong> ‚Äî <span class="chip">${s.tracking_number || 's/n'}</span><br/>
          <span class="muted">${s.status}</span>
          ${typeof s.tracking_seq === 'number' ? `<span class="chip">seq ${s.tracking_seq}</span>` : ''}
        </div>
        <div class="muted">Puntos: ${data.locations?.length || data.shipment?.locations?.length || 0}</div>
      `;

      // Normalizar lista de ubicaciones (la API /track y /track-seq devuelven shapes ligeramente distintos)
      const locs = data.locations || data.shipment?.locations || [];
      markersLayer.clearLayers();

      if (locs.length) {
        const bounds = [];
        for (const loc of locs) {
          const lat = Number(loc.lat), lon = Number(loc.lon);
          if (Number.isFinite(lat) && Number.isFinite(lon)) {
            const m = L.marker([lat, lon]).bindPopup(
              `üìç ${lat.toFixed(5)}, ${lon.toFixed(5)}<br/><span class="muted">${loc.ts || ''}</span>`
            );
            m.addTo(markersLayer);
            bounds.push([lat, lon]);
          }
        }
        if (bounds.length) map.fitBounds(bounds, { padding: [20,20] });
      }
    }

    async function fetchTrackByRef(ref) {
      const r = await fetch(`${API}/track/${encodeURIComponent(ref)}`);
      return r.json();
    }
    async function fetchTrackBySeq(seq) {
      const r = await fetch(`${API}/track-seq/${encodeURIComponent(seq)}`);
      return r.json();
    }

    async function loadByRef(ref) {
      ensureMap();
      const data = await fetchTrackByRef(ref);
      renderShipmentView(data);
    }
    async function loadBySeq(seq) {
      ensureMap();
      const data = await fetchTrackBySeq(seq);
      renderShipmentView(data);
    }

    // UI
    const input = document.getElementById('shipment_ref');
    document.getElementById('searchBtn').onclick = () => {
      const v = input.value.trim();
      if (v) loadByRef(v);
    };
    document.getElementById('viewAllBtn').onclick = async () => {
      const res = await fetch(`${API}/shipments`);
      const data = await res.json();
      const info = document.getElementById('resultInfo');
      const raw = document.getElementById('raw');
      raw.textContent = JSON.stringify(data, null, 2);
      if (!data.ok) { info.innerHTML = `<span style="color:#b00020">Error</span>`; return; }
      info.innerHTML = data.shipments.map(s =>
        `<div style="margin:6px 0">
           <strong>${s.ref_code}</strong> ‚Äî <span class="muted">${s.status}</span>
           <button class="chip" onclick="loadByRef('${s.ref_code}')">Ver en mapa</button>
         </div>`
      ).join('');
    };

    // Autocarga por URL (?ref= o ?seq=)
    ensureMap();
    const params = new URLSearchParams(location.search);
    const ref = params.get('ref');
    const seq = params.get('seq');
    if (ref) { input.value = ref; loadByRef(ref); }
    else if (seq) { input.value = ''; loadBySeq(seq); }
  </script>
</body>
</html>
