<script>
  // === Cargar mapa y marcador de env√≠os ===
  async function loadShipment(ref) {
    const resp = await fetch(`https://www.miguelescorp.com/shipments/${ref}`);
    const data = await resp.json();
    const infoDiv = document.getElementById("info");
    const mapDiv = document.getElementById("map");

    if (!data.ok) {
      infoDiv.innerHTML = `<p style="color:red;">No se encontr√≥ el env√≠o: ${ref}</p>`;
      mapDiv.innerHTML = "";
      return;
    }

    // Mostrar datos b√°sicos
    infoDiv.innerHTML = `
      <strong>${data.shipment.ref_code}</strong> ‚Äî ${data.shipment.status}<br>
      <span style="color:gray;">${data.shipment.locations.length} puntos</span>
    `;

    // Crear mapa
    const map = L.map("map").setView([25.77, -80.19], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Colocar los puntos
    for (const loc of data.shipment.locations) {
      L.marker([loc.lat, loc.lon]).addTo(map)
        .bindPopup(`üìç ${loc.lat.toFixed(4)}, ${loc.lon.toFixed(4)}`);
    }

    // Centrar mapa en el √∫ltimo punto
    const last = data.shipment.locations[data.shipment.locations.length - 1];
    if (last) map.setView([last.lat, last.lon], 13);
  }

  // === Detectar par√°metro ?ref= ===
  const params = new URLSearchParams(window.location.search);
  const refFromUrl = params.get("ref");

  const searchInput = document.getElementById("shipment_ref");
  const searchBtn = document.getElementById("searchBtn");

  // Si hay ref en URL, buscar autom√°ticamente
  if (refFromUrl) {
    searchInput.value = refFromUrl;
    loadShipment(refFromUrl);
  }

  // Buscar manualmente con bot√≥n
  searchBtn.onclick = () => {
    const ref = searchInput.value.trim();
    if (ref) loadShipment(ref);
  };
</script>
